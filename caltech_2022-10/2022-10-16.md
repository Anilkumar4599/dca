# Docker Swarm and Kubernetes

1. Create a Docker Compose file for the cluster using Docker Swarm (Docker Compose version 3):

    * https://docs.docker.com/compose/compose-file/compose-file-v3/

    ```
    tee ${PWD}/docker-swarm.yaml 0<<EOF

    # docker run --detach --name phpinfo --network phpinfo-default --restart always --publish 8080 --user nobody:nogroup --volume ${PWD}/index.php:/data/index.php:ro --workdir /data/ index.docker.io/library/php:alpine php -f index.php -S 0.0.0.0:8080
    configs:
      phpinfo-config:
        external: false
        file: index.php
    services:
      phpinfo:
        command:
          - php
          - -f
          - index.php
          - -S
          - 0.0.0.0:8080
        configs:
          - source: phpinfo-config
            target: /data/index.php
            uid: '65534'
            gid: '65534'
            mode: 0400
        deploy:
          placement:
            constraints:
              - "node.role==worker"      
          replicas: 1
        image: index.docker.io/library/php:alpine
        ports:
          - 8080
        user: nobody:nogroup
        working_dir: /data/
    version: '3.8'

    EOF
    ```
1. Now download the index.php artifact:

    ```
    wget https://raw.githubusercontent.com/academiaonline-org/phpinfo/main/src/index.php
    ```
1. Deploy the application with the following command:

    ```
    docker stack deploy --compose-file docker-swarm.yaml PHPINFO
    ```
1. We can scale up or down the application modifying the number of replicas in the Docker Compose manifest or with the following command:

    ```
    docker service scale PHPINFO_phpinfo=10
    ```
1. You can open a terminal inside the container for troubleshooting purposes with the following command:

    ```
    docker exec --interactive --tty PHPINFO_phpinfo.1.475n41g0f8cz99xlzhzcuee8v sh
    ```
    
3. In order to deploy the same application on a Kubernetes cluster we will need a list of independent Kubernetes manifests to create a list of independent Kubernetes objects. Instead of having a single Docker Compose manifest, we will have a collection of manifests to create the necessary Kubernets objects: Config Map, Service and Pod:

    ```
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: phpinfo-cm
    data:
      index.php: <?php phpinfo();?>
    ```  
    ```
    apiVersion: v1
    kind: Service
    metadata:
      name: phpinfo-svc-1
    spec:
      ports:
      - port: 8080
        protocol: TCP
      selector:
        app: phpinfo-deploy-1
    ```  
    ```
    apiVersion: v1
    kind: Service
    metadata:
      name: phpinfo-svc-2
    spec:
      ports:
      - port: 8080
        protocol: TCP
      selector:
        app: phpinfo-deploy-2
    ```      
    ```
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: phpinfo-deploy-1
    spec:
      replicas: 2
      selector:
        matchLabels:
          app: phpinfo-deploy-1
      template:
        metadata:
          labels:
            app: phpinfo-deploy-1
        spec:
          containers:
          - args:
            - php
            - -f
            - index.php
            - -S
            - 0.0.0.0:8080
            env:
            - name: OWNER
              value: Sebastian
            image: index.docker.io/library/php:8.0-alpine
            name: phpinfo-container
            resources:
              limits:
                cpu: 200m
                memory: 200M
              requests:
                cpu: 200m
                memory: 200M
            securityContext:
              readOnlyRootFilesystem: true
            volumeMounts:
            - mountPath: /data/index.php
              name: phpinfo-volume
              readOnly: true
              subPath: index.php
            workingDir: /data/
          volumes:
          - name: phpinfo-volume
            configMap:
              defaultMode: 0400
              items:
              - key: index.php
                mode: 0400
                path: index.php
              name: phpinfo-cm
    ```          
    ```
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: phpinfo-deploy-2
    spec:
      replicas: 2
      selector:
        matchLabels:
          app: phpinfo-deploy-2
      template:
        metadata:
          labels:
            app: phpinfo-deploy-2
        spec:
          containers:
          - args:
            - php
            - -f
            - index.php
            - -S
            - 0.0.0.0:8080
            env:
            - name: OWNER
              value: Sebastian
            image: index.docker.io/library/php:8.1-alpine
            name: phpinfo-container
            resources:
              limits:
                cpu: 200m
                memory: 200M
              requests:
                cpu: 200m
                memory: 200M
            securityContext:
              readOnlyRootFilesystem: true
            volumeMounts:
            - mountPath: /data/index.php
              name: phpinfo-volume
              readOnly: true
              subPath: index.php
            workingDir: /data/
          volumes:
          - name: phpinfo-volume
            configMap:
              defaultMode: 0400
              items:
              - key: index.php
                mode: 0400
                path: index.php
              name: phpinfo-cm
    ```          
1. In this link you will find the Reference for the Kubernetes API syntax:

    * https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/
